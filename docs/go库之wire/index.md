# Go库之wire


Google开源的依赖注入代码生成器

<!--more-->
## wire 介绍
Wire 是一个代码生成工具，它使用依赖注入自动连接组件。组件之间的依赖关系在 Wire 中表示为函数参数，鼓励显式初始化而不是全局变量。由于 Wire 在没有运行时状态或反射的情况下运行，因此编写用于 Wire 的代码即使对于手写初始化也很有用。

依赖注入(DI)经常和控制反转(IOC)放在一起讲，它是面向对象中的一种设计原则，可以用来减低代码间的耦合度。比如一个A类的构造方法中，依赖于一个B类，我们在初始化A之前需要先初始化B，然后才能初始化A。这个控制权在我们应用程序，而IOC需要有一个IOC容器，在我们初始化A时自动解析A的构造函数(反射)，将所依赖的对象B优先初始化，然后注入到A中，此处就是将控制权交与IOC容器进行管理。具体可参考Spring和Laravel等框架。

## wire 特点
上面介绍中也提到了wire是在没有运行时状态或反射下运行的，它不像其他的工具提供了运行时依赖注入（Uber的dig，Facebook的inject）,它是一种代码生成器，是在编译期间完成依赖注入生成Go源码。

## wire使用
https://github.com/li2251421/solution/tree/master/go/library/wire
### 安装wire工具
go get github.com/google/wire/cmd/wire
确保wire命令被添加到$GOPATH/bin目录下
### 定义提供者Providers
- provider是可以产生值的函数
- 函数必须导出才能被其他包使用(首字母大写)
- 使用参数指定依赖关系
- 可以返回错误、回调等多个值
- 多个提供者经常一起使用，可以通过wire.NewSet分组
```go
func New(dao *dao.Dao) *Service {
	return &Service{
		dao: dao,
	}
}

func New(db *DB, redis *Redis) *Dao {
    return &Dao{
        db:    db,
        redis: redis,
    }
}

func NewDB() *DB {
    return &DB{}
}

func NewRedis() *Redis {
    return &Redis{}
}
```

### 定义注入器Injector
- 文件第一行需要加入 // +build wireinject build tag，报这个生成注入器后不会报重复定义的编译错误(生成文件中build tag: //+build !wireinject)
- 通过wire.Build，传入provider set
- 函数内部会根据依赖顺序调用相关Provider
- 函数中没有真正的返回值，避免编译器报错，简单的用panic包裹即可  
- 通过wire命令生成注入器wire_gen.go
```go
wire.go
// +build wireinject
//go:generate wire
func InitWireApp() (*service.Service, func(), error) {
	panic(wire.Build(DBSet, dao.New, service.New))
}

var DBSet = wire.NewSet(dao.NewDB, dao.NewRedis)
```
```go
wire_gen.go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//+build !wireinject

//go:generate wire
func InitWireApp() (*service.Service, func(), error) {
    db := dao.NewDB()
    redis := dao.NewRedis()
    daoDao := dao.New(db, redis)
    serviceService := service.New(daoDao)
    return serviceService, func() {
    }, nil
}
```

## 高级功能
- 接口注入
- 属性自动注入
- 值绑定
- 把对象属性用作 Provider
- 清理函数

## Reference
- https://github.com/google/wire
- https://studygolang.com/articles/27163
- https://blog.golang.org/wire

